/*! lap v0.1.1 | Â© 2015 Joshua Kleckner | http://lokua.net/license-mit.html */
!function(a,b){"function"==typeof define&&define.amd?define("Lap",[],function(){return a.returnExportsGlobal=b()}):"object"==typeof exports?module.exports=b():a.Lap=b()}(this,function(){function a(a,c,d,e){var f=this;tooly.Handler.call(f),f.id=++b,f.container=a,f.lib=c,f.settings={};for(var g in f.defaultSettings)f.settings[g]=d.hasOwnProperty(g)?d[g]:f.defaultSettings[g];if(e||3===arguments.length)var h=setInterval(function(){"complete"===document.readyState&&(f.initialize(),clearInterval(h))},10);return f}var b=b||0,c=tooly.Frankie.bind(this);return tooly.inherit(tooly.Handler,a,function(){var a,b=_VOLUME_CHANGING=_PLAYLIST_OPEN=_DISCOG_OPEN=!1;return{defaultSettings:{callbacks:{},discogPlaylistExclusive:!0,plugins:null,prependTrackNumbers:!0,replacementText:void 0,startingAlbumIndex:0,startingTrackIndex:0,seekInterval:5,seekTime:250,selectorPrefix:"lap",trackNumberPostfix:" - ",useNativeProgress:!1,useNativeSeekRange:!1,useNativeVolumeRange:!1,volumeInterval:.05},selectors:{state:{playlistItemCurrent:"lap__playlist__item--current",playing:"lap--playing",paused:"lap--paused",hidden:"lap--hidden"},album:"lap__album",artist:"lap__artist",buffered:"lap__buffered",cover:"lap__cover",currentTime:"lap__current-time",discog:"lap__discog",discogItem:"lap__discog__item",discogPanel:"lap__discog__panel",duration:"lap__duration",info:"lap__info",infoPanel:"lap__info-panel",next:"lap__next",nextAlbum:"lap__next-album",playPause:"lap__play-pause",playlist:"lap__playlist",playlistItem:"lap__playlist__item",playlistPanel:"lap__playlist__panel",playlistTrackNumber:"lap__playlist__track-number",playlistTrackTitle:"lap__playlist__track-title",prev:"lap__prev",prevAlbum:"lap__prev-album",progress:"lap__progress",seekBackward:"lap__seek-backward",seekForward:"lap__seek-forward",seekRange:"lap__seek-range",trackNumber:"lap__track-number",trackTitle:"lap__track-title",volumeButton:"lap__volume-button",volumeDown:"lap__volume-down",volumeRead:"lap__volume-read",volumeRange:"lap__volume-range",volumeUp:"lap__volume-up"},initialize:function(){var a=this;1!==a.container.nodeType&&(a.container=c(a.container,document).get(0)),a.libType=tooly.type(a.lib),a.files=[],a.tracklist=[],a.$els=a.settings.elements,a.audio={},a.trackIndex=a.settings.startingTrackIndex,a.albumIndex=a.settings.startingAlbumIndex,a.trackCount,a.album="",a.trackTitle="",a.artist="",a.cover="",a.replacement="",a.update(),a.initAudio(),a.initElements(),a.addListeners(),a.registerCallbacks(a.settings.callbacks),a.initPlugins(),a.trigger("load")},initAudio:function(){this.audio=new Audio,this.audio.preload="auto";var a=this.getFileType(),b=this.audio.canPlayType("audio/"+a);"probably"===b||"maybe"===b?(this.setSource(),this.audio.volume=.8):console.log("This browser does not support "+a+" playback.")},initElements:function(){var a=this;a.$els={},tooly.each(a.selectors,function(b,d){if(!tooly.type(b,"object")){var e=c("."+b,a.container);e.zilch()||(a.$els[d]=e)}})},update:function(){var a=this;if("null"!==a.libType&&"undefined"!==a.libType){if("string"===a.libType){if("json"===tooly.extension(a.lib.toLowerCase())){if(tooly.getJSON(a.lib,function(b){a.lib=b},!1),"undefined"!==a.lib.data&&"array"===tooly.type(a.lib.data))return a.lib=a.lib.data,a.libType=tooly.type(a.lib),a.albumCount=a.lib.length,void a.update();if(a.libType=tooly.type(a.lib),"object"===a.libType)return a.albumCount=Object.keys(a.lib).length,void a.update()}a.files=[a.lib],a.tracklist=[a.lib],a.trackIndex=0,a.albumIndex=0,a.startingTrackIndex=0,a.startingAlbumIndex=0}else{if("object"!==a.libType&&"array"!==a.libType)throw new TypeError("Lap.lib must be of type String (audio or json file), Object, or Array");var b="array"===a.libType?a.lib[a.albumIndex]:a.lib;a.artist=b.artist,a.album=b.album,a.files=b.files,a.cover=b.cover,a.tracklist=b.tracklist,a.replacement=b.replacement}if(void 0!==a.replacement){var c=a.replacement;if("string"===tooly.type(c)&&(c=[c,""]),"regexp"!==tooly.type(c[0])){var d=c[2];c[0]=new RegExp(c[0],void 0!==d?d:"g")}}"string"===tooly.type(a.files)?a.trackCount=1:(a.logger.debug(a),a.trackCount=a.files.length),a.formatTracklist()}},formatTracklist:function(){var a=this;if(void 0===a.tracklist||a.trackCount>a.tracklist.length){for(var b=a.replacement,c=[],d=0;d<a.trackCount;d++)c[d]=tooly.sliceRel(tooly.stripExtension(a.files[d])),void 0!==b&&(c[d]=c[d].replace(b[0],b[1]));a.tracklist=c}},setSource:function(){var a=this.audio;a.src=this.files[this.trackIndex]},addListeners:function(){var a=this,b=a.$els,c=a.audio,d=a.settings.useNativeProgress&&b.progress&&b.progress.els.length;(b.buffered||d)&&c.addEventListener("progress",function(){var c=+a.bufferFormatted();b.buffered&&b.buffered.html(c),d&&(b.progress.get(0).value=c)}),b.currentTime&&c.addEventListener("timeupdate",function(){b.currentTime.html(a.currentTimeFormatted())}),b.duration&&c.addEventListener("durationchange",function(){b.duration.html(a.durationFormatted())}),b.volumeRead&&c.addEventListener("volumechange",function(){b.volumeRead.html(a.volumeFormatted())}),c.addEventListener("ended",function(){a.next(),a.audio.paused&&a.audio.play()}),b.playPause&&b.playPause.on("click",function(){a.togglePlay()}),b.prev&&b.prev.on("click",function(){a.prev()}),b.next&&b.next.on("click",function(){a.next()}),b.volumeUp&&b.volumeUp.on("click",function(){a.incVolume()}),b.volumeDown&&b.volumeDown.on("click",function(){a.decVolume()}),b.prevAlbum&&b.prevAlbum.on("click",function(){a.prevAlbum()}),b.nextAlbum&&b.nextAlbum.on("click",function(){a.nextAlbum()});var e=b.playlistPanel&&b.playlist,f=b.discogPanel&&b.discog;e&&b.playlist.on("click",function(){b.playlistPanel.hasClass(a.selectors.state.hidden)?(b.playlistPanel.removeClass(a.selectors.state.hidden),_PLAYLIST_OPEN=!0,f&&a.settings.discogPlaylistExclusive&&b.discogPanel.addClass(a.selectors.state.hidden)):(b.playlistPanel.addClass(a.selectors.state.hidden),_PLAYLIST_OPEN=!1,f&&a.settings.discogPlaylistExclusive&&_DISCOG_OPEN&&b.discogPanel.removeClass(a.selectors.state.hidden))}),f&&b.discog.on("click",function(){b.discogPanel.hasClass(a.selectors.state.hidden)?(b.discogPanel.removeClass(a.selectors.state.hidden),_DISCOG_OPEN=!0,e&&a.settings.discogPlaylistExclusive&&b.playlistPanel.addClass(a.selectors.state.hidden)):(b.discogPanel.addClass(a.selectors.state.hidden),_DISCOG_OPEN=!1,e&&a.settings.discogPlaylistExclusive&&_PLAYLIST_OPEN&&b.playlistPanel.removeClass(a.selectors.state.hidden))}),a.initSeekHandlers(),a.initVolumeHandlers(),a.on("load",function(){b.trackTitle&&a.updateTrackTitleEl(),b.trackNumber&&a.updateTrackNumberEl(),b.artist&&a.updateArtistEl(),b.album&&a.updateAlbumEl(),b.cover&&a.updateCover(),b.playlistPanel&&a.populatePlaylist(),b.playPause&&(b.playPause.addClass(a.selectors.state.paused),a.on("play",function(){b.playPause.removeClass(a.selectors.state.paused).addClass(a.selectors.state.playing)}).on("pause",function(){b.playPause.removeClass(a.selectors.state.playing).addClass(a.selectors.state.paused)}))}).on("trackChange",function(){b.trackTitle&&a.updateTrackTitleEl(),b.trackNumber&&a.updateTrackNumberEl(),b.playlistPanel&&a.updatePlaylistItem(),b.currentTime&&b.currentTime.html(a.currentTimeFormatted()),b.duration&&b.duration.html(a.durationFormatted())}).on("albumChange",function(){b.trackTitle&&a.updateTrackTitleEl(),b.trackNumber&&a.updateTrackNumberEl(),b.artist&&a.updateArtistEl(),b.album&&a.updateAlbumEl(),b.cover&&a.updateCover(),b.playlistPanel&&a.populatePlaylist()})},initSeekHandlers:function(){var d=this,e=d.$els,f=d.audio,g=e.seekRange,h=d.settings.useNativeSeekRange&&g&&g.els.length>0;h?(f.addEventListener("timeupdate",function(){b||(g.get(0).value=tooly.scale(f.currentTime,0,f.duration,0,100))}),g.on("mousedown",function(){b=!0}).on("mouseup",function(){var a=g.get(0);f.currentTime=tooly.scale(a.value,0,a.max,0,f.duration),d.trigger("seek"),b=!1})):[e.seekForward,e.seekBackward].forEach(function(e){e&&e.on("mousedown",function(a){b=!0,c(a.target).hasClass(d.selectors.seekForward)?d.seekForward():d.seekBackward()}).on("mouseup",function(){b=!1,clearTimeout(a)})})},initVolumeHandlers:function(){var a=this,b=a.$els,c=a.audio,d=b.volumeRange,e=a.settings.useNativeVolumeRange&&d&&d.els.length>0;e&&(c.addEventListener("volumechange",function(){_VOLUME_CHANGING||(d.get(0).value=a.volumeFormatted())}),d.on("mousedown",function(){_VOLUME_CHANGING=!0}).on("mouseup",function(){c.volume=.01*d.get(0).value,a.trigger("volumeChange"),_VOLUME_CHANGING=!1}))},initPlugins:function(){if(this.settings.plugins){this.plugins=this.plugins||[];var a=this,b=a.settings.plugins,c={},d=[];return b.forEach(function(b,e){b.constructor&&(c=b.args?tooly.construct(b.constructor,d.concat(a,b.args)):tooly.construct(b.constructor,a),a.plugins[e]=c,a.on("load",function(){a.plugins[e]&&a.plugins[e].init?a.plugins[e].init():console.error("Could not initialize "+a.plugins[e]+". The plugin has no #init property")}))}),this}},updateTrackTitleEl:function(){return this.$els.trackTitle.html(this.tracklist[this.trackIndex]),this},updateTrackNumberEl:function(){return this.$els.trackNumber.html(+this.trackIndex+1),this},updateArtistEl:function(){return this.$els.artist.html(this.artist),this},updateAlbumEl:function(){return this.$els.album.html(this.album),this},updateCover:function(){return this.$els.cover.get(0).src=this.cover,this},togglePlay:function(){return this.logger.debug("togglePlay -> this.audio.paused: %o",this.audio.paused),this.audio.paused?this.play():this.pause(),this.logger.debug("togglePlay -> this.audio.paused: %o",this.audio.paused),this.trigger("togglePlay"),this},play:function(){return this.audio.play(),this.trigger("play"),this},pause:function(){return this.audio.pause(),this.trigger("pause"),this},setTrack:function(a){this.trackIndex=0>=a?0:a>=this.trackCount?this.trackCount-1:a;var b=!this.audio.paused;return this.setSource(),b&&this.audio.play(),this.trigger("trackChange"),this},prev:function(){var a=!this.audio.paused;return this.trackIndex=this.trackIndex-1<0?this.trackCount-1:this.trackIndex-1,this.setSource(),a&&this.audio.play(),this.trigger("trackChange"),this},next:function(){var a=!this.audio.paused;return this.trackIndex=this.trackIndex+1>=this.trackCount?0:this.trackIndex+1,this.setSource(),a&&this.audio.play(),this.trigger("trackChange"),this},prevAlbum:function(){var a=!this.audio.paused;return this.albumIndex=this.albumIndex-1<0?this.albumCount-1:this.albumIndex-1,this.update(),this.trackIndex=0,this.setSource(),a&&this.audio.play(),this.trigger("albumChange"),this},nextAlbum:function(){var a=!this.audio.paused;return this.albumIndex=this.albumIndex+1>this.albumCount-1?0:this.albumIndex+1,this.update(),this.trackIndex=0,this.setSource(),a&&this.audio.play(),this.trigger("albumChange"),this},setAlbum:function(a){return this.albumIndex=0>=a?0:a>=this.albumCount?this.albumCount-1:a,this.update(),this.setTrack(this.lib[this.albumIndex].startingTrackIndex||0),this.trigger("albumChange"),this},incVolume:function(){return this.setVolume(!0),this},decVolume:function(){return this.setVolume(!1),this},setVolume:function(a){var b=this.audio.volume,c=this.settings.volumeInterval;return this.audio.volume=a?b+c>=1?1:b+c:0>=b-c?0:b-c,this.trigger("volumeChange"),this},seekBackward:function(){if(b){var c=this;return a=setInterval(function(){c.seek(!1)},c.settings.seekTime),c}},seekForward:function(){if(b){var c=this;return a=setInterval(function(){c.seek(!0)},c.settings.seekTime),c}},seek:function(a){return a?(applied=this.audio.currentTime+this.settings.seekInterval,this.audio.currentTime=applied>=this.audio.duration?this.audio.duration:applied):(applied=this.audio.currentTime+-1*this.settings.seekInterval,this.audio.currentTime=0>=applied?0:applied),this.trigger("seek"),this},populatePlaylist:function(){var a=this,b=a.$els.playlistPanel,d=a.settings.prependTrackNumbers;b.remove(),b.html(tooly.tag("ul",a.tracklist.map(function(b,c){var e="li ."+a.selectors.playlistItem+" "+(c===a.trackIndex?"."+a.selectors.state.playlistItemCurrent+" ":"")+'data-lap-playlist-index="'+c+'"';return tooly.tag(e,tooly.stringFormat("{0}{1}",d?tooly.tag("span ."+a.selectors.playlistTrackNumber,a.trackNumberFormatted(c+1)):"",tooly.tag("span ."+a.selectors.playlistTrackTitle,a.tracklist[c].trim())))}).join(""))),b.find("li").on("click",function(){var b=c(this);a.setTrack(b.attr("data-lap-playlist-index"))})},playlistFormatted:function(){var a=this,b=a.settings.prependTrackNumbers;return a.tracklist.map(function(c,d){return(b?a.trackNumberFormatted(d+1):"")+c.trim()})},updatePlaylistItem:function(){var a=this;return c("li",a.$els.playlistPanel).removeClass(a.selectors.state.playlistItemCurrent).eq(a.trackIndex).addClass(a.selectors.state.playlistItemCurrent),a},getFileType:function(){var a;return"string"===this.libType?a=this.lib:"object"===this.libType?a=this.lib.files[this.trackIndex]:"array"===this.libType&&(a=this.lib[this.albumIndex].files[this.trackIndex]),void 0===a?'"unknown filetype"':tooly.extension(a)},bufferFormatted:function(){if(!this.audio)return 0;var a,b=this.audio;try{a=b.buffered.end(b.buffered.length-1)}catch(c){return 0}var d=Math.round(tooly.scale(a,0,b.duration,0,100));return isNaN(d)?0:d},currentTimeFormatted:function(){var a=tooly.formatTime(Math.floor(this.audio.currentTime.toFixed(1)));return this.audio.duration<3600||"00:00:00"===a||"NaN:NaN:NaN"===a?a.slice(3):a},durationFormatted:function(){var a=tooly.formatTime(Math.floor(this.audio.duration.toFixed(1)));return this.audio.duration<3600||"00:00:00"===a||"NaN:NaN:NaN"===a?a.slice(3):a},volumeFormatted:function(){return Math.round(100*this.audio.volume)},trackNumberFormatted:function(a){var b=(""+this.trackCount).length-(""+a).length;return tooly.repeat("0",b)+a+this.settings.trackNumberPostfix},property:function(a){if("object"===this.libType&&this.lib.hasOwnProperty(a))return this.lib[a];if("array"===this.libType){for(var b=[],c=this.lib.length,d=0;c>d;d++)this.lib[d].hasOwnProperty(a)&&(b[d]=this.lib[d][a]);return b}},getTooly:function(){return tooly},getSelector:function(){return c}}}()),a});