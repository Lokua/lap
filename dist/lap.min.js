'use strict';

"use strict";!function(a,b){"function"==typeof define&&define.amd?define("Lap",[],function(){return a.returnExportsGlobal=b()}):"object"==typeof exports?module.exports=b():a.Lap=b()}(this,function(){function a(a){return this.context=a||this,this.context.handlers=[],this.handlers=this.context.handlers,this}function b(d,e,f){a.call(this);var g=this;g.name="Lokua Audio Player",g.version="0.0.5",g.doc="http://lokua.net/lap/0.0.5/doc/";{var h={debug:!1,startingTrackIndex:0,startingAlbumIndex:0,volumeInterval:.05,seekInterval:5,seekTime:250,prependTrackNumbers:!0,trackNumberPostfix:" - ",replacementText:void 0,elements:{albumTitle:".lap-album-title",artist:".lap-artist",buffered:".lap-buffered",control:".lap-control",controls:".lap-controls",cover:".lap-cover",currentTime:".lap-current-time",discog:".lap-discog",duration:".lap-duration",info:".lap-info",infoPanel:".lap-info-panel",next:".lap-next",nextAlbum:".lap-next-album",playPause:".lap-play-pause",playlist:".lap-playlist",playlistPanel:".lap-playlist-panel",prev:".lap-prev",prevAlbum:".lap-prev-album",seekBackward:".lap-seek-backward",seekForward:".lap-seek-forward",seekbar:".lap-seekbar",trackTitle:".lap-track-title",volumeButton:".lap-volume-button",volumeDown:".lap-volume-down",volumeRead:".lap-volume-read",volumeSlider:".lap-volume-slider",volumeUp:".lap-volume-up"},callbacks:{}};!function(){g.id=b.idGen++,g.settings=$.extend(!0,{},h,f),g.debug("debug mode is on"),g.$container=1===d.nodeType?d:c.select(d),g.lib=e,g.libType=c.toType(g.lib),g.files=[],g.trackTitles=[],g.$els=g.settings.elements,g.handlers={},g.audio={},g.trackIndex=g.settings.startingTrackIndex,g.albumIndex=g.settings.startingAlbumIndex,g.trackCount={},g.albumTitle="",g.trackTitle="",g.artist="",g.cover="",g.replacement="",g.updateCurrent(),g.initAudio(),g.initElements(h.elements),g.addListeners(),g.registerCallbacks(g.settings.callbacks),g.load()}()}return g}var c=function(){function a(a){return{}.toString.call(a).match(/\s([a-zA-Z]+)/)[1].toLowerCase()}function b(a){return new RegExp("s*"+a+"s*(?!W|w)","g")}function d(b,c,d){if("array"===a(c)){for(var e,f=0,g=b.length;g>f;f++)e=d(b[f],c);return e}}function e(b,c,d){if("array"===a(b))for(var e=0,f=b.length;f>e;e++)d(b[e],c)}var f=/\s+/;return{hasClass:function(a,e){if(!a)return!1;if(d(a,e,c.hasClass))return!0;if(1===a.nodeType){for(var g=b(e),h=a.className.split(f),i=h.length,j=0;i>j;j++)if(h[j].match(g)==e)return!0;return!1}throw new TypeError(a+" must be of nodeType: 1")},addClass:function(a,b){return a?(d(a,b,c.addClass),1===a.nodeType&&(a.className+=" "+b),c):c},removeClass:function(a,e){return a?(d(a,e,c.removeClass),1===a.nodeType&&(a.className=a.className.replace(b(e)," ")),c):c},prepend:function(a,b){return a?(e(a,b,c.prepend),(1===a.nodeType||9===a.nodeType)&&(a.innerHTML=b+a.innerHTML),c):c},append:function(a,b){return a?(e(a,b,c.append),(1===a.nodeType||9===a.nodeType)&&(a.innerHTML+=b),c):c},html:function(b,e){return b?1===arguments.length?"array"===a(b)?b[i].innerHTML:b.innerHTML:(d(b,e,c.html),(1===b.nodeType||9===b.nodeType)&&(b.innerHTML=e),c):c},select:function(a,b){return b=b||document,b.querySelector(a)},selectAll:function(a,b){for(var c=(b||document).querySelectorAll(a),d=[],e=0,f=c.length;f>e;e++)d[e]=c[e];return d},extend:function(a,b){a=a||{};for(var d in b)b.hasOwnProperty(d)&&(a[d]="object"===c.toType(d)?extend(a[d]=b[d]):b[d]);return a},fromPrototype:function(a,b){var d,e=c.objectCreate(a);for(d in b)b.hasOwnProperty(d)&&(e[d]=b[d]);return e},fromProto:function(a,b){return c.fromPrototype(a,b)},inherit:function(a,b,c){b.prototype=new a,b.prototype.constructor=b;for(var d in c)c.hasOwnProperty(d)&&(b.prototype[d]=c[d])},objectCreate:function(a){var b=function(){};return b.prototype=a,new b},propCount:function(a){var b=0;for(var c in a)a.hasOwnProperty(c)&&b++;return b},propsOf:function(a){var b=[];for(var c in a)a.hasOwnProperty(c)&&b.push(c);return b},endsWith:function(a,b){return-1!==a.indexOf(b,a.length-b.length)},format:function(a){var b=Array.prototype.slice.call(arguments,1);return a.replace(/{(\d+)}/g,function(a,c){return"undefined"!=typeof b[c]?b[c]:a})},formatTime:function(a){var b=Math.floor(a/3600),c=Math.floor((a-3600*b)/60),d=Math.floor(a-3600*b-60*c);return 10>b&&(b="0"+b),10>c&&(c="0"+c),10>d&&(d="0"+d),b+":"+c+":"+d},repeat:function(a,b){for(var c="",d=0;b>d;d++)c+=a;return c},scale:function(a,b,c,d,e){return(a-b)*(e-d)/(c-b)+d},sliceRel:function(a,b,c){var d=!1;return"/"===a.slice(-1)&&(d=!0,a=a.slice(0,-1)),a=a.slice(a.lastIndexOf("/")+1),d&&c&&(a=a.concat("/")),b&&(a="/"+a),a},toType:function(b){return a(b)}}}();return a.prototype={on:function(a,b){return void 0===this.handlers[a]&&(this.handlers[a]=[]),this.handlers[a].push(b),this},executeHandler:function(a){var b,c=this.handlers[a]||[],d=c.length;for(b=0;d>b;b++)c[b].apply(this.context,[]);return this},exec:function(a){return this.executeHandler(a)},registerCallbacks:function(a){var b=this;if(void 0!==a)for(var c in a)a.hasOwnProperty(c)&&b.on(c,a[c]);return b},toString:function(){return"[Handler ' "+this+" ']"}},b.idGen=(b.idGen||0)+1,c.inherit(a,b,function(){var a,b=!1;return{initElements:function(a){var b,d,e=this;"string"===c.toType(e.$els)&&"auto"===e.$els.toLowerCase()?(e.$els=[],b=a):b=e.$els;for(d in b)b.hasOwnProperty(d)&&(e.$els[d]=c.select(b[d],e.$container))},initAudio:function(){this.audio=new Audio,this.audio.preload="auto";var a=this.getFileType(),b=this.audio.canPlayType("audio/"+a);"probably"===b||"maybe"===b?(this.setSource(),this.audio.volume=.8):console.log("This browser does not support "+a+" playback.")},updateCurrent:function(){var a=this;if("null"!==a.libType&&"undefined"!==a.libType){if("string"===a.libType){if(c.endsWith(a.lib.toLowerCase(),".json")){if($.ajax({url:a.lib,dataType:"json",async:!1,success:function(b){a.lib=b}}),"undefined"!==a.lib.data&&"array"===c.toType(a.lib.data))return a.lib=a.lib.data,a.libType=c.toType(a.lib),void a.updateCurrent();if(a.libType=c.toType(a.lib),"object"===a.libType)return void a.updateCurrent()}a.files=[a.lib],a.trackTitles=[a.lib],a.trackIndex=0,a.albumIndex=0,a.startingTrackIndex=0,a.startingAlbumIndex=0}else{if("object"!==a.libType&&"array"!==a.libType)throw new TypeError("Lap.lib must be a string, object, or array. See "+a.doc+"tutorial-lib.html");var b="array"===a.libType?a.lib[a.albumIndex]:a.lib;a.artist=b.artist,a.album=b.album,a.files=b.files,a.cover=b.cover,a.trackTitles=b.trackTitles,a.replacement=b.replacement}if(void 0!==a.replacement&&("string"===c.toType(a.replacement)&&(a.replacement=[a.replacement,""]),"regexp"!==c.toType(a.replacement[0]))){var d=a.replacement[2];a.replacement[0]=void 0!==d?new RegExp(a.replacement[0],d):new RegExp(a.replacement[0],"g")}a.trackCount="string"===c.toType(a.files)?1:a.files.length,a.matchTrackTitles()}},matchTrackTitles:function(){var a,b=this;if(void 0===b.trackTitles||b.trackCount>b.trackTitles.length)for(b.trackTitles=[],a=0;a<b.trackCount;a++)b.trackTitles[a]=c.sliceRel(b.files[a].replace("."+b.getFileType(),"")),void 0!==b.replacement&&(b.trackTitles[a]=b.trackTitles[a].replace(b.replacement[0],b.replacement[1]))},setSource:function(){this.audio.src=this.files[this.trackIndex]},addListeners:function(){function d(d){null!==d&&(d.addEventListener("mousedown",function(a){b=!0,c.hasClass(a.target,"lap-seek-forward")?e.seekForward():e.seekBackward()}),d.addEventListener("mouseup",function(){b=!1,clearTimeout(a)}))}var e=this,f=e.$els,g=this.audio;g.addEventListener("timeupdate",function(){c.html(f.currentTime,e.currentTimeFormatted())}),g.addEventListener("durationchange",function(){c.html(f.duration,e.durationFormatted())}),g.addEventListener("volumechange",function(){c.html(f.volumeRead,e.volumeFormatted())}),g.addEventListener("ended",function(){e.next(),e.audio.paused&&e.audio.play()}),e.registerClick(f.playPause,e.togglePlay),e.registerClick(f.prev,e.prev),e.registerClick(f.next,e.next),e.registerClick(f.volumeUp,e.incVolume),e.registerClick(f.volumeDown,e.decVolume),e.registerClick(f.prevAlbum,e.prevAlbum),e.registerClick(f.nextAlbum,e.nextAlbum),e.registerClick(f.seekbar,e.seekFromSeekbar),e.$container.addEventListener("click",function(a){var b=a.target;if(c.hasClass(b,"lap-playlist-item")){var d=!e.audio.paused;e.trackIndex=parseInt(b.getAttribute("lap-data-index")),e.setSource(),e.executeHandler("trackChange"),d&&e.audio.play()}}),d(f.seekForward),d(f.seekBackward),this.on("load",function(){e.updateTrackTitleEl(),e.updateArtistEl(),e.updateAlbumEl(),e.updateCover(),e.populatePlaylist(),c.addClass(f.playPause,"lap-play")}).on("play",function(){c.removeClass(f.playPause,"lap-play").addClass(f.playPause,"lap-pause")}).on("pause",function(){c.removeClass(f.playPause,"lap-pause").addClass(f.playPause,"lap-play")}).on("trackChange",function(){e.updateTrackTitleEl(),e.updateCurrentPlaylistItem()}).on("albumChange",function(){e.updateTrackTitleEl(),e.updateArtistEl(),e.updateAlbumEl(),e.updateCover(),e.populatePlaylist()})},registerClick:function(a,b){var c=this;return a?(a.addEventListener("click",function(){b.call(c)}),c):c},load:function(){return this.executeHandler("load"),this},updateTrackTitleEl:function(){return c.html(this.$els.trackTitle,this.trackTitles[this.trackIndex]),this},updateArtistEl:function(){return c.html(this.$els.artist,this.artist),this},updateAlbumEl:function(){return c.html(this.$els.albumTitle,this.album),this},updateCover:function(){return null!==this.$els.cover&&(this.$els.cover.src=this.cover),this},togglePlay:function(){var a=this;return a.audio.paused?a.play():a.pause(),a.executeHandler("togglePlay"),a},play:function(){return this.audio.play(),this.executeHandler("play"),this},pause:function(){return this.audio.pause(),this.executeHandler("pause"),this},setTrack:function(a){return this.trackIndex=0>=a?0:a>=this.trackCount?this.trackCount-1:a,this.trackChange(),this},populatePlaylist:function(){var a=this,b=0,d="";for(c.html(a.$els.playlistPanel,""),b=0;b<a.trackCount;b++)d+=c.format("<div>{0}{1}{2}</div>",a.settings.prependTrackNumbers?'<span class="lap-track-number">'+a.trackNumberFormatted(b+1)+"</span>":"",'<span class="lap-playlist-item'+(b===a.trackIndex?" lap-current":"")+'" lap-data-index="'+b+'">',a.trackTitles[b].trim()+"</span>");c.append(a.$els.playlistPanel,d)},playlistFormatted:function(){for(var a=this,b=[],c=0;c<a.trackCount;c++)b[c]=a.settings.prependTrackNumbers?a.trackNumberFormatted(c+1):"",b[c]+=a.trackTitles[c];return b},trackNumberFormatted:function(a){var b=(this.trackCount+"").length-(a+"").length;return c.repeat("0",b)+a+this.settings.trackNumberPostfix},updateCurrentPlaylistItem:function(){for(var a=this,b=c.selectAll(".lap-playlist-item",a.$container),d=b.length,e=0;d>e;e++)if(b[e].getAttribute("lap-data-index")==a.trackIndex)return c.removeClass(b,"lap-current"),c.addClass(b[e],"lap-current"),a;return a},prev:function(){var a=this,b=!a.audio.paused;return a.trackIndex=a.trackIndex-1<0?a.trackCount-1:a.trackIndex-1,a.setSource(),b&&a.audio.play(),a.trackChange(),this},next:function(){var a=this,b=!a.audio.paused;return a.trackIndex=a.trackIndex+1>=a.trackCount?0:a.trackIndex+1,a.setSource(),b&&a.audio.play(),a.trackChange(),this},trackChange:function(){this.executeHandler("trackChange")},prevAlbum:function(){var a=this,b=!a.audio.paused;return a.albumIndex=a.albumIndex-1<=0?0:a.albumIndex-1,a.updateCurrent(),b&&a.audio.play(),a.albumChange(),this},nextAlbum:function(){var a=this,b=!a.audio.paused;return a.albumIndex=a.albumIndex+1>=a.lib.length?0:a.albumIndex+1,a.updateCurrent(),b&&a.audio.play(),a.albumChange(),this},albumChange:function(){this.executeHandler("albumChange")},incVolume:function(){return this.setVolume(!0),this},decVolume:function(){return this.setVolume(!1),this},setVolume:function(a){var b=this.audio.volume,c=this.settings.volumeInterval;return this.audio.volume=a?b+c>=1?1:b+c:0>=b-c?0:b-c,this.volumeChange(),this},volumeChange:function(){return this.executeHandler("volumeChange"),this},seekBackward:function(){if(b){var c=this;return a=setInterval(function(){c.seek(!1)},c.settings.seekTime),this}},seekForward:function(){if(b){var c=this;return a=setInterval(function(){c.seek(!0)},c.settings.seekTime),this}},seek:function(a){var b,c=this;return a?(b=c.audio.currentTime+c.settings.seekInterval,c.audio.currentTime=b>=c.audio.duration?c.audio.duration:b):(b=c.audio.currentTime+-1*c.settings.seekInterval,c.audio.currentTime=0>=b?0:b),this.executeHandler("seek"),this},seekFromSeekbar:function(a){var b=this,c=b.$els.seekbar.getBoundingClientRect();return b.audio.currentTime=(a.clientX-c.left)/c.width*b.audio.duration,b.executeHandler("seek"),this},getFileType:function(){var a;return"string"===this.libType?a=this.lib:"object"===this.libType?a=1===this.trackCount?this.lib.files:this.lib.files[this.trackIndex]:"array"===this.libType&&(a=1===this.trackCount?this.lib[this.albumIndex].files:this.lib[this.albumIndex].files[this.trackIndex]),void 0===a?'"unknown filetype"':a.slice(a.length-3)},currentTimeFormatted:function(){var a=c.formatTime(Math.floor(this.audio.currentTime.toFixed(1)));return this.audio.duration<3600?a.slice(3):a},durationFormatted:function(){var a=c.formatTime(Math.floor(this.audio.duration.toFixed(1)));return this.audio.duration<3600?a.slice(3):a},volumeFormatted:function(){return Math.round(100*this.audio.volume)},debug:function(a,b){if(this.settings.debug){var c="Lap[id:"+this.id+"] DEBUG		"+a;console.log(c+(2===arguments.length?": "+b:"")),b instanceof $&&console.log(b)}return this},debugProps:function(a,b,c){for(var d in a)a.hasOwnProperty(d)&&this.debug((b?b:"")+d+(c?c:""));return this},toString:function(){return Object.getOwnPropertyNames(this)}}}()),b});